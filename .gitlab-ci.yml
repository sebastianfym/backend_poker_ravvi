image: cr.yandex/crpa15giodgbluup12vl/ci_python:latest

stages:
- build
- test

variables:
  PIP_CACHE_DIR: "/home/ravvi/.cache/pip"

build:
  stage: build
  cache:
    paths:
      - ${PIP_CACHE_DIR}
  before_script:
    - source ~/.profile
  script:
    - python3 ./setup.py bdist_wheel
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - dist/

test:
  stage: test
  needs:
    - build
  dependencies:
    - build
  cache:
    paths:
      - ${PIP_CACHE_DIR}
  services:
    - postgres:15.2
  variables:
    POSTGRES_PASSWORD: password
    RAVVI_POKER_DB_HOST: postgres
    RAVVI_POKER_DB_PORT: 5432
    RAVVI_POKER_DB_USER: postgres
    RAVVI_POKER_DB_PASSWORD: ${POSTGRES_PASSWORD}
  before_script:
    - source ~/.profile
  script:
    - pip3 install dist/*.whl
    - cd tests/
    - coverage run ravvi_poker_backend_db create tests
    - coverage run --append -m pytest --junitxml=tests.xml .
    - coverage report
    - coverage xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: tests/tests.xml
      coverage_report:
        coverage_format: cobertura
        path: tests/coverage.xml
